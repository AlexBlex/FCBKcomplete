/*
 FCBKcomplete 2.7.1
 - Jquery version required: 1.2.x, 1.3.x, 1.4.x
 
 Changelog:
 - 2.00	new version of fcbkcomplete
 
 - 2.01 fixed bugs & added features
 		fixed filter bug for preadded items
		focus on the input after selecting tag
		the element removed pressing backspace when the element is selected
		input tag in the control has a border in IE7
		added iterate over each match and apply the plugin separately
		set focus on the input after selecting tag
 
 - 2.02 fixed fist element selected bug
		fixed defaultfilter error bug
 
 - 2.5 	removed selected="selected" attribute due ie bug
		element search algorithm changed
		better performance fix added
		fixed many small bugs
		onselect event added
		onremove event added
 
 - 2.6 	ie6/7 support fix added
		added new public method addItem due request
		added new options "firstselected" that you can set true/false to select first element on dropdown list
		autoexpand input element added
		removeItem bug fixed
		and many more bug fixed
 		fixed public method to use it $("elem").trigger("addItem",[{"title": "test", "value": "test"}]);
		
- 2.7 	jquery 1.4 compability
 		item lock possability added by adding locked class to preadded option <option value="value" class="selected locked">text</option>
 		maximum item that can be added

- 2.7.1 bug fixed
		ajax delay added thanks to http://github.com/dolorian

 */
/* Coded by: emposha <admin@emposha.com> */
/* Copyright: Emposha.com <http://www.emposha.com/> - Distributed under MIT - Keep this message! */
/*
 * json_url         - url to fetch json object
 * cache       		- use cache
 * height           - maximum number of element shown before scroll will apear
 * newel            - show typed text like a element
 * firstselected	- automaticly select first element from dropdown
 * filter_case      - case sensitive filter
 * filter_selected  - filter selected items from list
 * complete_text    - text for complete page
 * maxshownitems	- maximum numbers that will be shown at dropdown list (less better performance)
 * onselect			- fire event on item select
 * onremove			- fire event on item remove
 * maxitimes		- maximum items that can be added
 * delay			- delay between ajax request (bigger delay, lower server time request)
 */
jQuery(function(g){g.fn.fcbkcomplete=function(J){return this.each(function(){function K(){L();M();A(0)}function L(){l.hide();l.attr("multiple","multiple");l.attr("name").indexOf("[]")==-1&&l.attr("name",l.attr("name")+"[]");m=g(document.createElement("ul"));m.attr("class","holder");l.after(m);k=g(document.createElement("div"));k.addClass("facebook-auto");k.append('<div class="default">'+f.complete_text+"</div>");if(p){k.append('<iframe class="ie6fix" scrolling="no" frameborder="0"></iframe>');q=k.children(".ie6fix")}c= g(document.createElement("ul"));c.attr("id",v+"_feed");k.prepend(c);m.after(k);c.css("width",k.width())}function M(){l.children("option").each(function(d,a){a=g(a);if(a.hasClass("selected")){s(a.text(),a.val(),true,a.hasClass("locked"));a.attr("selected","selected")}else a.removeAttr("selected");o.push({caption:a.text(),value:a.val()});t+=""+(o.length-1)+":"+a.text()+";"})}function s(d,a,b,j){if(!B())return false;var h=document.createElement("li"),n=document.createTextNode(d),r=document.createElement("a"); j="bit-box"+(j?" locked":"");g(h).attr({"class":j,rel:a});g(h).prepend(n);g(r).attr({"class":"closebutton",href:"#"});h.appendChild(r);m.append(h);g(r).click(function(){C(g(this).parent("li"));return false});if(!b){g("#"+v+"_annoninput").remove();A(1);if(l.children("option[value="+a+"]").length){b=l.children("option[value="+a+"]");b.get(0).setAttribute("selected","selected");b.hasClass("selected")||b.addClass("selected")}else{b=g(document.createElement("option"));b.attr("value",a).get(0).setAttribute("selected", "selected");b.attr("value",a).addClass("selected");b.text(d);l.append(b)}f.onselect.length&&D(f.onselect,b)}m.children("li.bit-box.deleted").removeClass("deleted");c.hide();p&&q.hide()}function C(d){if(!d.hasClass("locked")){d.fadeOut("fast");if(f.onremove.length){var a=l.children("option[value="+d.attr("rel")+"]");D(f.onremove,a)}l.children('option[value="'+d.attr("rel")+'"]').removeAttr("selected").removeClass("selected");d.remove();x=0}}function A(d){var a=g(document.createElement("li")),b=g(document.createElement("input")), j=0;a.attr({"class":"bit-input",id:v+"_annoninput"});b.attr({type:"text","class":"maininput",size:"1"});m.append(a.append(b));b.focus(function(){k.fadeIn("fast")});b.blur(function(){k.fadeOut("fast")});m.click(function(){b.focus();if(c.length&&b.val().length)c.show();else{c.hide();p&&q.hide();k.children(".default").show()}});b.keypress(function(h){if(h.keyCode==13)return false;b.attr("size",b.val().length+1)});b.keydown(function(h){if(h.keyCode==191){h.preventDefault();return false}});b.keyup(function(h){var n= E(b.val());if(h.keyCode==8&&n.length==0){c.hide();p&&q.hide();if(!m.children("li.bit-box:last").hasClass("locked"))if(m.children("li.bit-box.deleted").length==0){m.children("li.bit-box:last").addClass("deleted");return false}else{if(x)return;x=1;m.children("li.bit-box.deleted").fadeOut("fast",function(){C(g(this));return false})}}if(h.keyCode!=40&&h.keyCode!=38&&n.length!=0){w=0;if(f.json_url)if(f.cache&&F){y(n);z()}else{j++;var r=j;setTimeout(function(){if(r==j)g.getJSON(f.json_url+(f.json_url.indexOf("?")> -1?"&":"?")+"tag="+n,null,function(u){y(n,u);F=true;z()})},f.delay)}else{y(n);z()}k.children(".default").hide();c.show()}});d&&setTimeout(function(){b.focus();k.children(".default").show()},1)}function y(d,a){c.html("");if(!f.cache){o=[];t=""}N(d);a!=null&&a.length&&g.each(a,function(r,u){o.push({caption:u.caption,value:u.value});t+=""+(o.length-1)+":"+u.caption+";"});a=f.maxshownitems<o.length?f.maxshownitems:o.length;var b="i";if(f.filter_case)b="";var j,h;try{j=eval("/(?:^|;)\\s*(\\d+)\\s*:[^;]*?"+ d+"[^;]*/g"+b);h=j.exec(t)}catch(n){}for(b="";h!=null&&a>0;){h=o[h[1]];if(!(f.filter_selected&&l.children("option[value="+h.value+"]").hasClass("selected"))){b+='<li rel="'+h.value+'">'+O(h.caption,d)+"</li>";w++;a--}h=j.exec(t)}c.append(b);if(f.firstselected){e=c.children("li:visible:first");e.addClass("auto-focus")}if(w>f.height){c.css({height:f.height*24+"px",overflow:"auto"});p&&q.css({height:f.height*24+"px",width:c.width()+"px"}).show()}else{c.css("height","auto");p&&q.css({height:c.height()+ "px",width:c.width()+"px"}).show()}}function O(d,a){if(f.filter_case)try{eval("var text = text.replace(/(.*)("+a+")(.*)/gi,'$1<em>$2</em>$3');")}catch(b){}else try{eval("var text = text.replace(/(.*)("+a.toLowerCase()+")(.*)/gi,'$1<em>$2</em>$3');")}catch(j){}return d}function G(){c.children("li").mouseover(function(){c.children("li").removeClass("auto-focus");g(this).addClass("auto-focus");e=g(this)});c.children("li").mouseout(function(){g(this).removeClass("auto-focus");e=null})}function H(){c.children("li").unbind("mouseover"); c.children("li").unbind("mouseout");c.mousemove(function(){G();c.unbind("mousemove")})}function z(){var d=g("#"+v+"_annoninput").children(".maininput");G();c.children("li").unbind("mousedown");c.children("li").mousedown(function(){var a=g(this);s(a.text(),a.attr("rel"));c.hide();p&&q.hide();k.hide()});d.unbind("keydown");d.keydown(function(a){if(a.keyCode==191){a.preventDefault();return false}a.keyCode!=8&&m.children("li.bit-box.deleted").removeClass("deleted");if(a.keyCode==13&&I()){var b=e;s(b.text(), b.attr("rel"));k.hide();a.preventDefault();e=null;return false}if(a.keyCode==13&&!I()){if(f.newel){b=E(g(this).val());s(b,b);k.hide();a.preventDefault();e=null}return false}if(a.keyCode==40){H();if(e==null||e.length==0){e=c.children("li:visible:first");c.get(0).scrollTop=0}else{e.removeClass("auto-focus");e=e.nextAll("li:visible:first");b=parseInt(e.prevAll("li:visible").length,10);var j=parseInt(e.nextAll("li:visible").length,10);if((b>Math.round(f.height/2)||j<=Math.round(f.height/2))&&typeof e.get(0)!= "undefined")c.get(0).scrollTop=parseInt(e.get(0).scrollHeight,10)*(b-Math.round(f.height/2))}c.children("li").removeClass("auto-focus");e.addClass("auto-focus")}if(a.keyCode==38){H();if(e==null||e.length==0){e=c.children("li:visible:last");c.get(0).scrollTop=parseInt(e.get(0).scrollHeight,10)*(parseInt(c.children("li:visible").length,10)-Math.round(f.height/2))}else{e.removeClass("auto-focus");e=e.prevAll("li:visible:first");b=parseInt(e.prevAll("li:visible").length,10);j=parseInt(e.nextAll("li:visible").length, 10);if((j>Math.round(f.height/2)||b<=Math.round(f.height/2))&&typeof e.get(0)!="undefined")c.get(0).scrollTop=parseInt(e.get(0).scrollHeight,10)*(b-Math.round(f.height/2))}c.children("li").removeClass("auto-focus");e.addClass("auto-focus")}})}function B(){if(f.maxitems!=0)return m.children("li.bit-box").length<f.maxitems?true:false}function N(d){if(f.newel&&B()){c.children("li[fckb=1]").remove();if(d.length!=0){var a=g(document.createElement("li"));a.attr({rel:d,fckb:"1"}).html(d);c.prepend(a);w++}}} function D(d,a){var b="";for(i=0;i<a.get(0).attributes.length;i++)if(a.get(0).attributes[i].nodeValue!=null)b+='"_'+a.get(0).attributes[i].nodeName+'": "'+a.get(0).attributes[i].nodeValue+'",';b="{"+b+" notinuse: 0}";try{eval(d+"("+b+")")}catch(j){}}function I(){if(e==null)return false;if(e.length==0)return false;return true}function E(d){d=d.replace(/[\"\'][\s]*javascript:(.*)[\"\']/g,'""');d=d.replace(/script(.*)/g,"");d=d.replace(/eval\((.*)\)/g,"");return d=d.replace("/([\u0000-\u0008,\u000b-\u000c,\u000e-\u0019])/", "")}g(this).bind("addItem",function(d,a){s(a.title,a.value)});var f=g.extend({json_url:null,cache:false,height:"10",newel:false,firstselected:false,filter_case:false,filter_hide:false,complete_text:"Start to type...",maxshownitems:30,maxitems:0,onselect:"",onremove:"",delay:350},J),m=null,c=null,k=null,w=0,o=[],F=false,t="",e=null,x=0,p=false,q,l=g(this),v=l.attr("id");K();return this})}});